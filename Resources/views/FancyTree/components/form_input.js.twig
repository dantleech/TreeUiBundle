{% if options.form_input_multiple %}
    options.selectMode = 2;
{% else %}
    options.selectMode = 1;
{% endif %}

options.checkbox = true;

var form = treeEl.closest('form');

form.submit(function() {
    var tree = treeEl.fancytree('getTree');
    var id = 'cmf_ui_tree_widget_' + tree._id;
    var inputs = tree.$container.find("div#" + id);

    if(inputs.length){
        inputs.empty();
    } else {
        inputs = $("<div>", {
            id: id
        }).hide().appendTo(tree.$container);
    }

    var nodeList = tree.getSelectedNodes( tree.options.selectMode === 3 );
    var inputName = "{{ options.form_input_name }}";

    if (options.selectMode = 2) {
        inputName += "[]";
    }

    $.each(nodeList, function(idx, node){
        inputs.append($("<input>", {
            type: "checkbox",
            name: inputName,
            value: node.key,
            checked: true
        }));
    });
});
